# BathroomClimateController
IOT sensor tracking humidity and temperature of your bathroom to avoid mold


_Basic Idea_: As it was advised last winter to reduce heating if possible, mold become a problem. Thus the idea of this project is to sensor:

**1) Humidity**

**2) Temperature**

These two values will be then set off against each other in some sort of simple physical model to know if the room (e.g. bathroom) is too humid or too cold and to take what measure (e.g. increase ventilation or heating).

The mentioned values will be retrievable by on a web API (implemented on the device or pushed to a remote web API).

Ideally the bathroom climate control unit enables you to prevent mold but allows you at the same time to save energy as it balances these two goals.

## How to set everything up ##

1. Set 

> https://raw.githubusercontent.com/espressif/arduino-esp32/gh-pages/package_esp32_index.json

In your Arduino **"File" → "Preferences" → "Additional Boards Manager URLs"**

2. Get all the files from git with _git pull_

3. Connect Sensor to your computer and choose Board by "Tools" → "Board" → "M5Stack" → "M5Stack-ATOM"

4. In Arduino click CTRL+Shift+M to display the Serial Monitor. There you have to set Bauds = 600 to see the output of the program.


## Sensors ##

Sensor **ENV III** https://shop.m5stack.com/collections/m5-sensor/products/env-iii-unit-with-temperature-humidity-air-pressure-sensor-sht30-qmp6988 seems to fullfill our requirements and is quite cheap.


## Data handling and storage ##

### Space considerations for stack implementations ###
Arduino says after compilation:

```
Sketch uses 751733 bytes (57%) of program storage space. Maximum is 1310720 bytes.
Global variables use 44448 bytes (13%) of dynamic memory, leaving 283232 bytes for local variables. Maximum is 327680 bytes.
```

We can get exactly **110580 Bytes** on the whole M5 by malloc. Therefore these 110580 Bytes have to be split up into two arrays. As **size of float = 4 Bytes** and **size of unsigned short = 2 Bytes** one array to store data of 2 and the other to store data of 4 Bytes:

110580 Bytes / 6 = 18430 Bytes. Thus array one (2B) gets 2 * 18430 and array two (4B) gets 4 * 18430. 

Check: 2 Bytes * 18430 + 4 Bytes * 18430 = 110580 Bytes ✓

```
// Allocate memory for the temperature and humidity data arrays
  temp = (float*) malloc(dataSize * sizeof(float));  // 4 Bytes
  hum = (unsigned short*) malloc(dataSize * sizeof(unsigned short));  // 2 Bytes
```
### Traversals ###
We iterate through these arrays with **currentIndex** - set back to zero after reaching the tail (by modulo). By this the data is refreshed automatically and doesn't need to be popped or pushed, as it is a queue. The size limit cannot be removed because we're working with the maximum of available space.


## Testing ##
As there is only one sensor available, we can **mock sensor data** with random temperature and humidity. With this data filled in our storage arrays, we can calculate and send (mocked) data to the webserver and display it.

### Mocking sensor data ###

```
// Generates and prints 'count' random numbers in range [lower, upper].
int printRandoms(int lower, int upper)
{
    return (rand() % (upper - lower + 1)) + lower;
}
```

```
// *** Mock sensor ***
  // Use current time as seed for random generator
  srand(time(0));
  
  // Set random temp
  temp[currentIndex] = printRandoms(16, 32);  

  // Set random humidity
  hum[currentIndex] = printRandoms(50, 100);
  // *** End of mocking ***
```
Of course temperature and humidity aren't this random, but we can fill our array in short time and then do calculations on it.

## Webserver and webpage ##
With the includes: <WiFi.h>, <WiFiClient.h> and <WiFiAP.h> we let run a little webserver and an access point on the M5.

When running, a connection can be made to Hotspot: **BathroomClimateAssistant** with password = '123456789'. Then there should be a website under 192.168.4.1 (works better on a pc than on my smartphone - if anyone has this problem).

The webserver serves a single, quite simple HTML page, which is generated by simple "println"-lines in file **webServer.cpp**. To convert valid HTML to this special version, you can use the following script to append a pre- and a postfix to every line (don't forget to escape the double quotes first: '"' has to become '\"').


```
sed -e 's/^/client.println("/' index-escaped.html > index-escaped-prefix.html

```

```
sed -e 's/$/");/' index-escaped-prefix.html > index-escaped-prefix-postfix.html

```


##### Display / plot data #####
The nearby solution to plot data in a small webserver is Javascript. Unfortunately every Javascript library supporting plotting uses 1) a lot of space and 2) even if downloaded and included locally in webserver of M5 there are still some further links to further libraries as the Javascript universe is huge.

Therefore BathroomClimateAssistant uses HTML Canvas to display simple graphs to plot temperature and humidity, see https://www.w3schools.com/graphics/canvas_drawing.asp.


### Automated Build Pipeline ### 
In GitLab you can find your pipelines on the left side in menu point "CI/CD" - "Pipelines"

- https://medium.com/swlh/how-to-create-an-automated-build-pipeline-for-your-arduino-project-1df9826f2a5e

- https://medium.com/swlh/how-to-create-an-automated-build-pipeline-for-your-arduino-project-1df9826f2a5e

- https://arduino.stackexchange.com/questions/74781/can-i-integrate-arduino-in-a-ci-cd-setup


#### Setup arduino-cli ####

Install arduino-cli, then follow these instructions:
https://arduino.github.io/arduino-cli/0.21/getting-started/

Problems with USB ports (under Linux):
https://github.com/arduino/arduino-cli/issues/1543


### HOWTOs / Learning material ###
- Nice playlist "How to Get Started Learning Embedded Systems": https://www.youtube.com/watch?v=aC37UE7edP0&list=PL9IEJIKnBJjEcPAz6fss-Hx0TLytCOMVC

- Allocating memory with malloc, calloc, realloc, and free: https://www.youtube.com/watch?v=P6oqhAxV0dA&pp=ygUTamFjb2Igc29yYmVyIG1hbGxvYw%3D%3D

- Learn GIT: https://learngitbranching.js.org

- Instructions on the installation: https://randomnerdtutorials.com/installing-the-esp32-board-in-arduino-ide-windows-instructions/

- https://www.eeweb.com/a-temperature-sensor-with-m5stack/


**Technical Problems**
- https://support.arduino.cc/hc/en-us/articles/360016495679-Fix-port-access-on-Linux
- 
